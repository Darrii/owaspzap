// Global variables
let currentAnalysisId = null;

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    initializeNavigation();
    initializeFileUpload();
    loadAnalyses();
    loadRules();
});

// Navigation
function initializeNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (this.getAttribute('target') === '_blank') return;

            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);

            // Update active nav
            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // Update active section
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
        });
    });
}

// File Upload
function initializeFileUpload() {
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');

    // Drag and drop
    uploadBox.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadBox.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadBox.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileSelect(this.files[0]);
        }
    });

    // Make upload box clickable
    uploadBox.addEventListener('click', function(e) {
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });
}

// Handle file selection
async function handleFileSelect(file) {
    // Validate file
    if (!file.name.endsWith('.json')) {
        alert('Please select a JSON file');
        return;
    }

    // Show progress
    showProgress('Uploading file...');

    try {
        // Upload file
        const formData = new FormData();
        formData.append('file', file);

        updateProgress(30, 'Uploading file...');

        const uploadResponse = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        if (!uploadResponse.ok) {
            throw new Error('Upload failed');
        }

        const uploadData = await uploadResponse.json();
        currentAnalysisId = uploadData.analysis_id;

        updateProgress(50, 'Analyzing vulnerability chains...');

        // Start analysis
        const maxChainLength = document.getElementById('maxChainLength').value;
        const minConfidence = document.getElementById('minConfidence').value;
        const minRiskFilter = document.getElementById('minRiskFilter').value;

        const analysisResponse = await fetch(`/api/analyze/${currentAnalysisId}?max_chain_length=${maxChainLength}&min_confidence=${minConfidence}&min_risk_filter=${minRiskFilter}`, {
            method: 'POST'
        });

        if (!analysisResponse.ok) {
            throw new Error('Analysis failed');
        }

        const analysisData = await analysisResponse.json();

        updateProgress(100, 'Analysis complete!');

        // Show results
        setTimeout(() => {
            hideProgress();
            displayResults(analysisData);
        }, 500);

    } catch (error) {
        hideProgress();
        alert('Error: ' + error.message);
        console.error('Error:', error);
    }
}

// Progress functions
function showProgress(text) {
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    updateProgress(10, text);
}

function updateProgress(percent, text) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = text;
}

function hideProgress() {
    document.getElementById('progressSection').style.display = 'none';
}

// Display results
function displayResults(data) {
    document.getElementById('resultsSection').style.display = 'block';

    // Stats
    const statsHtml = `
        <div class="stat-card">
            <div class="stat-value">${data.statistics.total_vulnerabilities}</div>
            <div class="stat-label">Total Vulnerabilities</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.statistics.total_chains}</div>
            <div class="stat-label">Chains Detected</div>
        </div>
        <div class="stat-card critical">
            <div class="stat-value">${data.statistics.critical_chains}</div>
            <div class="stat-label">Critical Chains</div>
        </div>
        <div class="stat-card high">
            <div class="stat-value">${data.statistics.high_risk_chains}</div>
            <div class="stat-label">High Risk Chains</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.statistics.analysis_time.toFixed(2)}s</div>
            <div class="stat-label">Analysis Time</div>
        </div>
    `;
    document.getElementById('statsGrid').innerHTML = statsHtml;

    // Chains preview
    if (data.chains_summary && data.chains_summary.length > 0) {
        const chainsHtml = `
            <h4>Top Chains</h4>
            ${data.chains_summary.map(chain => `
                <div class="chain-item ${getRiskClass(chain.risk_score)}">
                    <div class="chain-header">
                        <span class="chain-type">${chain.type}</span>
                        <span class="chain-risk">${chain.risk_score.toFixed(1)}</span>
                    </div>
                    <div class="chain-path">${chain.summary}</div>
                </div>
            `).join('')}
        `;
        document.getElementById('chainsPreview').innerHTML = chainsHtml;
    }

    // Setup action buttons
    document.getElementById('viewHtmlBtn').onclick = () => window.open(`/api/report/${currentAnalysisId}/html`, '_blank');
    document.getElementById('viewJsonBtn').onclick = () => window.open(`/api/report/${currentAnalysisId}/json`, '_blank');
    document.getElementById('downloadHtmlBtn').onclick = () => window.location.href = `/api/download/${currentAnalysisId}/html`;
    document.getElementById('downloadJsonBtn').onclick = () => window.location.href = `/api/download/${currentAnalysisId}/json`;
}

function getRiskClass(riskScore) {
    if (riskScore >= 15) return 'critical';
    if (riskScore >= 10) return 'high';
    return '';
}

// Load analyses
async function loadAnalyses() {
    const listElement = document.getElementById('analysesList');
    listElement.innerHTML = '<p class="loading">Loading...</p>';

    try {
        const response = await fetch('/api/analyses');
        const data = await response.json();

        if (data.analyses.length === 0) {
            listElement.innerHTML = '<p class="loading">No analyses yet. Upload a ZAP report to get started.</p>';
            return;
        }

        const html = data.analyses.map(analysis => `
            <div class="analysis-item">
                <div class="analysis-info">
                    <h4>Analysis ${analysis.analysis_id}</h4>
                    <p>${new Date(analysis.timestamp).toLocaleString()}</p>
                    <p>${analysis.total_chains} chains (${analysis.critical_chains} critical, ${analysis.high_risk_chains} high risk)</p>
                </div>
                <div class="analysis-actions">
                    <button class="btn btn-info" onclick="viewAnalysis('${analysis.analysis_id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger" onclick="deleteAnalysis('${analysis.analysis_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `).join('');

        listElement.innerHTML = html;

    } catch (error) {
        listElement.innerHTML = '<p class="loading">Error loading analyses</p>';
        console.error('Error:', error);
    }
}

async function viewAnalysis(analysisId) {
    window.open(`/api/report/${analysisId}/html`, '_blank');
}

async function deleteAnalysis(analysisId) {
    if (!confirm('Are you sure you want to delete this analysis?')) {
        return;
    }

    try {
        const response = await fetch(`/api/analysis/${analysisId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadAnalyses();
        } else {
            alert('Failed to delete analysis');
        }
    } catch (error) {
        alert('Error: ' + error.message);
        console.error('Error:', error);
    }
}

// Load rules
async function loadRules() {
    const statsElement = document.getElementById('rulesStats');
    const listElement = document.getElementById('rulesList');

    listElement.innerHTML = '<p class="loading">Loading...</p>';

    try {
        const response = await fetch('/api/rules');
        const data = await response.json();

        // Stats
        const statsHtml = `
            <div class="rules-stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${data.total_rules}</div>
                    <div class="stat-label">Total Rules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.statistics.unique_source_types}</div>
                    <div class="stat-label">Source Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.statistics.unique_target_types}</div>
                    <div class="stat-label">Target Types</div>
                </div>
            </div>
        `;
        statsElement.innerHTML = statsHtml;

        // Rules
        const html = data.rules.map(rule => `
            <div class="rule-card">
                <h4>${rule.name}</h4>
                <p><strong>Type:</strong> ${rule.chain_type}</p>
                <p><strong>Exploitability:</strong> ${(rule.exploitability * 100).toFixed(0)}%</p>
                <p><strong>Impact Multiplier:</strong> ${rule.impact_multiplier}x</p>
                <p>${rule.description}</p>
                <div class="rule-chain">
                    <span>${rule.source_type}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span>${rule.target_type}</span>
                </div>
            </div>
        `).join('');

        listElement.innerHTML = html;

    } catch (error) {
        listElement.innerHTML = '<p class="loading">Error loading rules</p>';
        console.error('Error:', error);
    }
}
