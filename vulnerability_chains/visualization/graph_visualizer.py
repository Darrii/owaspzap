"""
GraphVisualizer - Visualization of vulnerability chains and graphs.
"""

import logging
import json
from typing import List, Dict, Any, Optional
from pathlib import Path
import networkx as nx
from datetime import datetime

logger = logging.getLogger(__name__)


class GraphVisualizer:
    """
    Visualizer for vulnerability chains and graphs.
    """

    def __init__(self):
        """Initialize the visualizer."""
        self.output_dir = Path("reports/chains")
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def generate_html_report(
        self,
        result: Any,  # ChainDetectionResult
        output_file: Optional[str] = None
    ) -> str:
        """
        Generate comprehensive HTML report for chain detection results.

        Args:
            result: ChainDetectionResult object
            output_file: Output file path (auto-generated if None)

        Returns:
            Path to generated HTML file
        """
        if output_file is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_file = str(self.output_dir / f"chain_report_{timestamp}.html")

        logger.info(f"Generating HTML report: {output_file}")

        html_content = self._build_html_report(result)

        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(html_content)

        logger.info(f"HTML report generated: {output_file}")
        return output_file

    def _build_html_report(self, result: Any) -> str:
        """
        Build HTML content for the report.

        Args:
            result: ChainDetectionResult object

        Returns:
            HTML string
        """
        from ..models import ChainDetectionResult

        # Build HTML sections
        header = self._build_header()
        summary = self._build_summary_section(result)
        top_chains = self._build_top_chains_section(result)
        all_chains = self._build_all_chains_section(result)
        graph_viz = self._build_graph_visualization_section(result)
        footer = self._build_footer()

        html = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Chain Detection Report</title>
    {self._get_css_styles()}
</head>
<body>
    {header}
    <div class="container">
        {summary}
        {top_chains}
        {all_chains}
        {graph_viz}
    </div>
    {footer}
    {self._get_javascript()}
</body>
</html>
"""
        return html

    def _build_header(self) -> str:
        """Build HTML header section."""
        return """
    <header>
        <div class="container">
            <h1>üîó Vulnerability Chain Detection Report</h1>
            <p class="subtitle">Graph-based Analysis of Compound Exploits</p>
        </div>
    </header>
"""

    def _build_summary_section(self, result: Any) -> str:
        """Build summary statistics section."""
        timestamp = result.timestamp.strftime("%Y-%m-%d %H:%M:%S")

        # Calculate verification statistics
        verified_chains = sum(1 for c in result.chains if c.verified is True)
        exploitable_chains = sum(1 for c in result.chains if c.verified is True and c.is_verified_exploitable())
        verification_rate = (verified_chains / result.total_chains * 100) if result.total_chains > 0 else 0

        # Check if any chains have been verified
        has_verification = any(c.verified is not None for c in result.chains)

        verification_cards = ""
        if has_verification:
            verification_cards = f"""
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="stat-value">{verified_chains}</div>
                <div class="stat-label">Verified Chains</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="stat-value">{exploitable_chains}</div>
                <div class="stat-label">Exploitable Chains</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <div class="stat-value">{verification_rate:.0f}%</div>
                <div class="stat-label">Verification Rate</div>
            </div>
"""

        return f"""
    <section class="summary">
        <h2>üìä Summary</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{result.total_vulnerabilities}</div>
                <div class="stat-label">Total Vulnerabilities</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{result.total_chains}</div>
                <div class="stat-label">Chains Detected</div>
            </div>
            <div class="stat-card critical">
                <div class="stat-value">{result.critical_chains}</div>
                <div class="stat-label">Critical Chains</div>
            </div>
            <div class="stat-card high">
                <div class="stat-value">{result.high_risk_chains}</div>
                <div class="stat-label">High Risk Chains</div>
            </div>
            {verification_cards}
            <div class="stat-card">
                <div class="stat-value">{result.analysis_time:.2f}s</div>
                <div class="stat-label">Analysis Time</div>
            </div>
        </div>
        <p class="timestamp">Generated: {timestamp}</p>
    </section>
"""

    def _build_top_chains_section(self, result: Any) -> str:
        """Build top chains section."""
        if not result.chains:
            return """
    <section class="top-chains">
        <h2>üîù Top Vulnerability Chains</h2>
        <p class="no-data">No vulnerability chains detected.</p>
    </section>
"""

        # Get top 10 chains
        top_chains = sorted(result.chains, key=lambda c: c.risk_score, reverse=True)[:10]

        chains_html = ""
        for i, chain in enumerate(top_chains, 1):
            risk_class = self._get_risk_class(chain.risk_score)
            vuln_path = " ‚Üí ".join([v.name for v in chain.vulnerabilities])

            chains_html += f"""
        <div class="chain-card {risk_class}">
            <div class="chain-header">
                <span class="chain-rank">#{i}</span>
                <span class="chain-type">{chain.chain_type.value.upper()}</span>
                <span class="chain-risk">{chain.risk_score:.1f}</span>
            </div>
            <div class="chain-path">{vuln_path}</div>
            <div class="chain-details">
                <div class="detail-item">
                    <strong>Length:</strong> {len(chain)} vulnerabilities
                </div>
                <div class="detail-item">
                    <strong>Confidence:</strong> {chain.confidence:.0%}
                </div>
                <div class="detail-item">
                    <strong>Impact:</strong> {chain.impact_description}
                </div>
            </div>
            <div class="chain-steps">
                <strong>Exploitation Steps:</strong>
                <ol>
"""
            for step in chain.exploitation_steps:
                chains_html += f"                    <li>{step}</li>\n"

            chains_html += """
                </ol>
            </div>
        </div>
"""

        return f"""
    <section class="top-chains">
        <h2>üîù Top Vulnerability Chains</h2>
        {chains_html}
    </section>
"""

    def _build_all_chains_section(self, result: Any) -> str:
        """Build section with all chains table."""
        if not result.chains:
            return ""

        rows_html = ""
        for i, chain in enumerate(result.chains, 1):
            risk_class = self._get_risk_class(chain.risk_score)
            vuln_path = " ‚Üí ".join([v.name[:30] for v in chain.vulnerabilities])

            # Add verification status badge
            verification_badge = self._get_verification_badge(chain)

            rows_html += f"""
            <tr class="{risk_class}">
                <td>{i}</td>
                <td>{chain.chain_type.value}</td>
                <td class="chain-path-cell">{vuln_path}</td>
                <td>{len(chain)}</td>
                <td>{chain.risk_score:.1f}</td>
                <td>{chain.confidence:.0%}</td>
                <td>{verification_badge}</td>
            </tr>
"""

        return f"""
    <section class="all-chains">
        <h2>üìã All Detected Chains</h2>
        <div class="table-wrapper">
            <table class="chains-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Type</th>
                        <th>Chain Path</th>
                        <th>Length</th>
                        <th>Risk Score</th>
                        <th>Confidence</th>
                        <th>Verification</th>
                    </tr>
                </thead>
                <tbody>
                    {rows_html}
                </tbody>
            </table>
        </div>
    </section>
"""

    def _build_graph_visualization_section(self, result: Any) -> str:
        """Build graph visualization section (placeholder for future enhancement)."""
        return """
    <section class="graph-viz">
        <h2>üï∏Ô∏è Graph Visualization</h2>
        <div class="viz-placeholder">
            <p>Interactive graph visualization coming soon...</p>
            <p>The vulnerability graph contains {0} nodes and their relationships.</p>
        </div>
    </section>
""".format(result.total_vulnerabilities)

    def _build_footer(self) -> str:
        """Build HTML footer."""
        return """
    <footer>
        <div class="container">
            <p>Generated by Vulnerability Chain Detection System</p>
            <p>SIAAS Research Team ¬© 2025</p>
        </div>
    </footer>
"""

    def _get_css_styles(self) -> str:
        """Get CSS styles for the report."""
        return """
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        section {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.critical {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .stat-card.high {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .timestamp {
            text-align: right;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .chain-card {
            background: white;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chain-card.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .chain-card.high {
            border-left-color: #ea580c;
            background: #fff7ed;
        }

        .chain-card.medium {
            border-left-color: #f59e0b;
            background: #fefce8;
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chain-rank {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .chain-type {
            background: #f3f4f6;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .chain-risk {
            background: #dc2626;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .chain-path {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
            margin: 15px 0;
            padding: 15px;
            background: #f9fafb;
            border-radius: 5px;
        }

        .chain-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 5px;
        }

        .chain-steps {
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 5px;
        }

        .chain-steps ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .chain-steps li {
            margin: 8px 0;
            color: #4b5563;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .chains-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .chains-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .chains-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chains-table tr:hover {
            background: #f9fafb;
        }

        .chains-table tr.critical {
            background: #fef2f2;
        }

        .chains-table tr.high {
            background: #fff7ed;
        }

        .chains-table tr.medium {
            background: #fefce8;
        }

        .chain-path-cell {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Verification badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .badge-exploitable {
            background: #10b981;
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .badge-verified {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .badge-not-verified {
            background: #ef4444;
            color: white;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .badge-not-tested {
            background: #9ca3af;
            color: white;
            box-shadow: 0 2px 4px rgba(156, 163, 175, 0.3);
        }

        .viz-placeholder {
            text-align: center;
            padding: 60px;
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        footer {
            background: #1f2937;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 40px;
        }

        footer p {
            margin: 5px 0;
        }

        @media print {
            body {
                background: white;
            }
            section {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
    </style>
"""

    def _get_javascript(self) -> str:
        """Get JavaScript for interactive features."""
        return """
    <script>
        // Add interactive features here in the future
        console.log('Vulnerability Chain Detection Report loaded');
    </script>
"""

    @staticmethod
    def _get_risk_class(risk_score: float) -> str:
        """Get CSS class based on risk score."""
        if risk_score >= 15.0:
            return 'critical'
        elif risk_score >= 10.0:
            return 'high'
        elif risk_score >= 5.0:
            return 'medium'
        else:
            return 'low'

    @staticmethod
    def _get_verification_badge(chain: Any) -> str:
        """
        Get verification status badge HTML.

        Args:
            chain: VulnerabilityChain object

        Returns:
            HTML badge string
        """
        if chain.verified is None:
            # Not tested
            return '<span class="badge badge-not-tested">Not Tested</span>'

        elif chain.verified and chain.is_verified_exploitable():
            # Verified and exploitable (confidence >= 80%)
            conf = chain.verification_confidence or 0.0
            verified_count = chain.verified_vulns_count or 0
            total_count = len(chain.vulnerabilities)
            return f'''<span class="badge badge-exploitable" title="Verified: {verified_count}/{total_count} vulnerabilities, Confidence: {conf:.0%}">
                ‚úì Exploitable ({conf:.0%})
            </span>'''

        elif chain.verified:
            # Verified but low confidence
            conf = chain.verification_confidence or 0.0
            verified_count = chain.verified_vulns_count or 0
            total_count = len(chain.vulnerabilities)
            return f'''<span class="badge badge-verified" title="Verified: {verified_count}/{total_count} vulnerabilities, Confidence: {conf:.0%}">
                ‚úì Verified ({conf:.0%})
            </span>'''

        else:
            # Not verified
            return '<span class="badge badge-not-verified">‚úó Not Verified</span>'

    def export_to_json(
        self,
        result: Any,
        output_file: Optional[str] = None
    ) -> str:
        """
        Export chain detection results to JSON.

        Args:
            result: ChainDetectionResult object
            output_file: Output file path (auto-generated if None)

        Returns:
            Path to generated JSON file
        """
        if output_file is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_file = str(self.output_dir / f"chain_results_{timestamp}.json")

        logger.info(f"Exporting results to JSON: {output_file}")

        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(result.to_dict(), f, indent=2, ensure_ascii=False)

        logger.info(f"JSON export completed: {output_file}")
        return output_file

    def __repr__(self) -> str:
        """String representation of the visualizer."""
        return f"GraphVisualizer(output_dir={self.output_dir})"
